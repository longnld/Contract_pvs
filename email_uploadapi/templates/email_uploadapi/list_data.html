{%load static%}
{%load extensiontag %}
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Data display</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap 5 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
    <!-- Import bootstrap cdn -->
    <link rel="stylesheet" href=
"https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
        integrity=
"sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2"
        crossorigin="anonymous">
  
    <!-- Import jquery cdn -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity=
"sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous">
    </script>
      
    <script src=
"https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
        integrity=
"sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
        crossorigin="anonymous">
    </script>
    <style>
      .modal-dialog {
        width: auto;
        max-width: 960px;
        word-wrap: break-word;
      }
    </style>
</head>
  <body>
  <!-- Image and text -->
  <nav class="navbar navbar-light bg-light">
    <img src="{% static 'img/logo_PVS_Hub_v4.png'%}" width="30" height="30" class="d-inline-block align-top" alt="None">
    <a class="navbar-brand" href="{% url "email_api:list_data" %}"style="font-family:verdana" >Emails Display</a>
   <a class="navbar-brand"  href="{% url "index" %}" style="font-family:verdana">HOME</a>
   <form class="form-inline my-2 my-lg-0">
    <input type="text" id="myInput" onkeyup="myFunction()" placeholder="Search for subjects..">
  </form>
</nav>

<table class="table" table class="table align-middle mb-0 bg-white">            
                  <thead class="bg-light">
                    <tr class="header">
                      <th scope="col">ID</th>
                      <th scope="col">Subject</th>
                      <th scope="col">Attachments</th>
                      <th scope="col">Date to receive</th>
                      <th scope="col">Date to close</th>
                      <th scope="col">
                        <select onchange="getid(this.value)" id="status" class="form-select form-select-sm fw-bold" aria-label="Default select example">
                          <option>Status</option>
                          <option value="open"  >Open</option>
                          <option value="close" >Close</option>
                          <option value="processing" >Processing</option> 
                          <option value="pending" >Pending</option>
                      </th>
                      <th scope="col" >Action</th>
                    </tr>
                  </thead>
                </div>
    <tbody id="emails_table">
      
      {% for i in list_email %}
      <tr 
      {% if i.status == "open" %}
        class="table-danger"
      {% elif i.status == "processing" %}
        class="table-primary"
      {% elif i.status == "close" %}
        class="table-success"
      {% elif i.status == "pending" %}
        class="table-warning"
      {% endif %} 
        >
        <td > {{i.pk}}</td>
        <td > 
          <strong class="fw-normal mb-1" style="font-size:20px"> {{i.Subject|truncatechars:30}}</strong>
          <p class="text-muted mb-0" style=" width: 100px;text-overflow: ellipsis;overflow: hidden;"><strong>Note:</strong>{{i.note|truncatewords:8}}</p></td>
        <td>{% for attach in i.Attachments.all %}
            <a href="/media/{{attach}}" style="text-decoration: none;">{{attach|truncatechars:10}}</a>    
            {%if attach|extensiontags == "pdf"%}   
            <button type="button" class="btn btn-primary 
            btn-sm" data-toggle="modal" 
            data-target="#exampleModal"
            id="media/{{attach}}"
            onclick="getid2(this.id)"
            style="display: inline;padding:1px 10px;ground:white">Contract robotics</button>  
            {%endif%}
            <br>
            {%endfor%}</td>
        <td>{{i.created|date:"d/m/Y"}}</td>
        <td>{{i.date_to_close|date:"d/m/Y"}}</td>
        <td >{{i.status}}</td>
        <td><a  class="btn btn-link btn-rounded btn-sm fw-bold" href="update_email/{{i.pk}}" style="text-decoration: none;">Edit</a></td>
      </tr>
      {% endfor %}  
    </tbody>
</table>
</div>
    </div>
    <!-- Modal -->
    <div class="modal fade" id="exampleModal" 
    tabindex="-1" 
    aria-labelledby="exampleModalLabel" 
    aria-hidden="true">
      
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" 
                    id="exampleModalLabel">
                    PDFreading
                </h5>
                  
                <button type="button" 
                    class="close" 
                    data-dismiss="modal" 
                    aria-label="Close">
                    <span aria-hidden="true">
                        ×
                    </span>
                </button>
            </div>

            <div class="modal-body">

                <!-- Data passed is displayed 
                    in this part of the 
                    modal body -->
                <h6 id="modal_body"></h6>

                <h6 id="modal_body8"></h6>   
                <h6 id="modal_body9"></h6>
                <h6 id="modal_body10"></h6>
                <h6 id="modal_body11"></h6>
                <h6 id="modal_body12"></h6>
                <h6 id="modal_body13"></h6>
                <h6 id="modal_body14"></h6>
                <h6 id="modal_body15"></h6>
                <h6 id="modal_body16"></h6>
                <h6 id="modal_body17"></h6>
                <h6 id="modal_body18"></h6>
                <h6 id="modal_body19"></h6>


                <button type="button" 
                    class="btn btn-success btn-sm" 
                    data-toggle="modal"
                    data-target="#exampleModal" 
                    id="">
                    Submit
                </button>
            </div>
        </div>
    </div>
</div>
</div>
  <script>
    function getid2(id){
      $.ajax({
        type: 'get',
        url: "{% url 'pdf_upload:reading' %}?file=" + id,
        processData: false,
        contentType: false,
        cache: false,
        success: function(resp) {
          console.log(resp.lists);
          if(resp.lists["Hợp đồng"] || resp.lists['Bên A'] || resp.lists['Bên B'])  {
            $("#modal_body").html(`"Hợp đồng": ${resp.lists["Hợp đồng"]["Hợp đồng"] }<br>
            "Số hợp đồng": ${resp.lists["Hợp đồng"]["Số hợp đồng"] }<hr>
            "Bên A": ${resp.lists["Bên A"]["Bên A"]}<br>
            "địa chỉ": ${resp.lists["Bên A"]["địa chỉ"]}<br>
            "Mã số thuế": ${resp.lists["Bên A"]["Mã số thuế"]} <hr>
            "Bên B": ${resp.lists["Bên B"]['Người đại diện']}<br>
            "địa chỉ": ${resp.lists["Bên B"]['địa chỉ']}<br>
            "Mã số thuế": ${resp.lists["Bên B"]['Mã số thuế']}<hr>
            `);
                if(resp.lists["Cước phí sử dụng dịch vụ"]){
                  <!--Cước phí sử dụng dịch vụ -->
                  $("#modal_body8").html(`"Tiền trước thuế": ${resp.lists["Cước phí sử dụng dịch vụ"]['Tiền trước thuế']}`); 
                  if (resp.lists["Cước phí sử dụng dịch vụ"]['Danh mục']){
                    $("#modal_body9").html(`"Tiền sau thuế": ${resp.lists["Cước phí sử dụng dịch vụ"]['Tiền sau thuế']}`);
                    $("#modal_body10").html(`"Danh mục": ${resp.lists["Cước phí sử dụng dịch vụ"]['Danh mục']}<hr>`);}
                  else{
                    $("#modal_body9").html(`"Tiền sau thuế": ${resp.lists["Cước phí sử dụng dịch vụ"]['Tiền sau thuế']}<hr>`);
                  }
                }
                else{$("#modal_body8").html(``); $("#modal_body9").html(``); $("#modal_body10").html(``);
                }
                if(resp.lists["Chi phí đấu nối hòa mạng"]){
                  <!--Chi phí đấu nối hòa mạng -->
                  $("#modal_body11").html(`"Tiền trước thuế": ${resp.lists["Chi phí đấu nối hòa mạng"]['Tiền trước thuế']}`);   
                  if (resp.lists["Chi phí đấu nối hòa mạng"]['Danh mục']){
                    $("#modal_body12").html(`"Tiền sau thuế": ${resp.lists["Chi phí đấu nối hòa mạng"]['Tiền sau thuế']}`);
                    $("#modal_body13").html(`"Danh mục": ${resp.lists["Chi phí đấu nối hòa mạng"]['Danh mục']}<hr>`);}
                  else{
                    $("#modal_body12").html(`"Tiền sau thuế": ${resp.lists["Chi phí đấu nối hòa mạng"]['Tiền sau thuế']}<hr>`);
                  }
                }
                else{$("#modal_body11").html(``);$("#modal_body12").html(``); $("#modal_body13").html(``);}
                if(resp.lists["Chi phí hàng tháng"]){
                  <!--Chi phí hàng tháng -->
                  $("#modal_body14").html(`"Tiền trước thuế": ${resp.lists["Chi phí hàng tháng"]['Tiền trước thuế']}`);   
                  if (resp.lists["Chi phí hàng tháng"]['Danh mục']){
                    $("#modal_body15").html(`"Tiền sau thuế": ${resp.lists["Chi phí hàng tháng"]['Tiền sau thuế']}`);
                    $("#modal_body16").html(`"Danh mục": ${resp.lists["Chi phí hàng tháng"]['Danh mục']}<hr>`);}
                  else{
                    $("#modal_body15").html(`"Tiền sau thuế": ${resp.lists["Chi phí hàng tháng"]['Tiền sau thuế']}<hr>`);}
                  }
                else{$("#modal_body14").html(``);$("#modal_body15").html(``);
                $("#modal_body16").html(``);}
                  if(resp.lists["Chi phí lắp đặt"]){
                  <!--Chi phí lắp đặt -->
                  $("#modal_body17").html(`"Tiền trước thuế": ${resp.lists["Chi phí lắp đặt"]['Tiền trước thuế']}`);   
                  if (resp.lists["Chi phí lắp đặt"]['Danh mục']){
                    $("#modal_body18").html(`"Tiền sau thuế": ${resp.lists["Chi phí lắp đặt"]['Tiền sau thuế']}`);
                    $("#modal_body19").html(`"Danh mục": ${resp.lists["Chi phí lắp đặt"]['Danh mục']}<hr>`);}
                  else{
                    $("#modal_body18").html(`"Tiền sau thuế": ${resp.lists["Chi phí lắp đặt"]['Tiền sau thuế']}<hr>`);}
                  }
                  else{$("#modal_body17").html(``);$("#modal_body18").html(``);$("#modal_body19").html(``);}
                  }  
                  
          else{
            $("#modal_body").html(`"Không có các trường được hy vọng": <hr> ${resp.lists}`);
            $("#modal_body8").html(``); $("#modal_body9").html(``); $("#modal_body10").html(``); $("#modal_body11").html(``);
            $("#modal_body12").html(``); $("#modal_body13").html(``);$("#modal_body14").html(``);$("#modal_body15").html(``);
            $("#modal_body16").html(``);$("#modal_body17").html(``);$("#modal_body18").html(``);$("#modal_body19").html(``);}
        },
      }); // end ajax 
    }

  </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <script>
      function myFunction() {
        // Declare variables
        var input, filter, table, tr, td, i, txtValue;
        input = document.getElementById("myInput");
        filter = input.value.toUpperCase();
        table = document.getElementById("emails_table");
        tr = table.getElementsByTagName("tr");
      
        // Loop through all table rows, and hide those who don't match the search query
        for (i = 0; i < tr.length; i++) {
          td = tr[i].getElementsByTagName("td")[1];
          if (td) {
            txtValue = td.textContent || td.innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
              tr[i].style.display = "";
            } else {
              tr[i].style.display = "none";
            }
          }
        }
      }
      </script>
      <script>
        function getid(pk) {
          $.ajax({
            type: 'get',
            url: "{% url 'email_api:filter_status' %}?status=" + pk,
            processData: false,
            contentType: false,
            cache: false,
            success: function(resp) {
              console.log(resp.data_resp);          
              $("#emails_table").html(`${resp.data_resp}`);
            },
          }); // end ajax 
        }
      </script>
      <nav class="navbar navbar-light bg-light">
        <a class="navbar-brand" href="{% url "email_api:list_data" %}"style="font-family:verdana" ><img src="{% static 'img/logo_PVS_Hub_v4.png'%}" width="30" height="30" class="d-inline-block align-top" alt="None">
        Emails Display</a>
       <a class="navbar-brand"  href="{% url "index" %}" style="font-family:verdana">HOME</a>
       <form class="form-inline my-2 my-lg-0">
        <input type="text" id="myInput" onkeyup="myFunction()" placeholder="Search for subjects..">
      </form>
    </nav>
</body>
</html>